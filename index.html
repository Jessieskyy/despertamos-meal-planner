<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Planificador de Comidas</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: 'Comic Sans MS', cursive;
      background: black; color: white;
      text-align: center;
    }
    video#background, video#cerrada-video {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover;
      z-index: -1;
    }
    #cocina-cerrada {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.6);
      color: red;
      font-size: 4vw;
      z-index: 2;
      display: flex;
      justify-content: center;
      align-items: center;
      text-shadow: 0 0 10px red;
    }
    #wake-button {
      position: relative;
      top: 40vh;
      font-size: 2rem;
      padding: 1rem 2rem;
      border: none;
      border-radius: 30px;
      background: #ff4b2b;
      color: white;
      cursor: pointer;
      z-index: 1;
    }
    .meal-block {
      position: relative;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 20px;
      margin: 1rem auto;
      padding: 1rem;
      width: 90%;
      max-width: 350px;
      font-size: 1.2rem;
      z-index: 1;
    }
    .meal-block button {
      margin-top: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      border: none;
      background: #4caf50;
      color: white;
      cursor: pointer;
    }
    .status {
      margin-top: 0.5rem;
      font-size: 2rem;
    }
    .done { color: #0f0; }
    .missed { color: #f00; }

    /* Loader overlay */
    #loader-container {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.75);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    #loader-container img {
      width: 120px;
      height: 120px;
      margin-bottom: 1rem;
      animation: bounce 1.5s infinite ease-in-out;
    }
    #loader-text {
      color: #fff;
      font-size: 1.5rem;
      font-weight: bold;
      font-family: 'Comic Sans MS', cursive;
      text-shadow: 0 0 5px #00ff00;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
  </style>
</head>
<body>

<video id="background" autoplay muted loop src="https://jessieskyy.github.io/despertamos-meal-planner/frog_picnic.mp4"></video>
<video id="cerrada-video" autoplay muted loop src="https://jessieskyy.github.io/despertamos-meal-planner/cocina_cerrada.mp4"></video>
<div id="cocina-cerrada">Cocina Cerrada</div>

<button id="wake-button">¡Despertamos!</button>
<div id="meals"></div>

<!-- Loader -->
<div id="loader-container">
  <img src="https://jessieskyy.github.io/despertamos-meal-planner/fat_frog.png" alt="Loading frog" />
  <div id="loader-text">Cargando horarios...</div>
</div>

<script>
  const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfqhAxYZX-dYDBQySEUtxIpXmzMTRzYw83KFi20qkMC8gF21A/formResponse';
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/1XEeQL89J-Hd1AiGTOwBbkXYgOInf_m9Z1tPvTI-S3d4/gviz/tq?tqx=out:csv&sheet=Meal%20Planner';
  const PARTS = ["Dadiva", "Cypher", "Harbinjer", "Evyr"];

  const wakeBtn = document.getElementById("wake-button");
  const mealsDiv = document.getElementById("meals");
  const cerradaVid = document.getElementById("cerrada-video");
  const cerradaScreen = document.getElementById("cocina-cerrada");
  const loaderContainer = document.getElementById("loader-container");

  let meals = [], statusArr = [], refreshInterval;

  function getTodayStr() {
    return new Date().toISOString().split('T')[0];
  }

  function hasPressedWakeToday() {
    return localStorage.getItem('wakePressedDate') === getTodayStr();
  }

  function setWakePressedToday() {
    localStorage.setItem('wakePressedDate', getTodayStr());
  }

  function stdTime(t) {
    let [h, m] = t.split(':').map(Number);
    const ap = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${h}:${m.toString().padStart(2, '0')} ${ap}`;
  }

  function parseTime(t) {
    const [h_m, ap] = t.split(' ');
    let [h, m] = h_m.split(':').map(Number);
    if (ap === 'PM' && h < 12) h += 12;
    if (ap === 'AM' && h === 12) h = 0;
    const d = new Date();
    d.setHours(h, m, 0, 0);
    return d;
  }

  function submitMeal(i, st) {
    const fd = new URLSearchParams();
    fd.append('entry.1742440048', getTodayStr());
    fd.append('entry.530673272', 'Auto');
    fd.append('entry.867522782', st);
    PARTS.forEach(p => fd.append('entry.916852138', p));
    fetch(FORM_URL, { method: 'POST', mode: 'no-cors', body: fd });
  }

  function displayMeals() {
    mealsDiv.innerHTML = '';
    const now = new Date();
    let allDone = true;

    meals.forEach((t, i) => {
      const mealTime = parseTime(t);
      const diff = mealTime - now;
      const late = now - mealTime;

      const block = document.createElement('div');
      block.className = 'meal-block';
      block.innerHTML = `<div>Comida ${i + 1}: ${stdTime(t)}</div>`;

      const status = document.createElement('div');
      status.className = 'status';

      if (statusArr[i] === 'done') {
        status.textContent = '✅';
        status.classList.add('done');
      } else if (statusArr[i] === 'missed') {
        status.textContent = '❌';
        status.classList.add('missed');
      } else if (diff > 0) {
        status.textContent = `En ${Math.ceil(diff / 60000)} min`;
        allDone = false;
      } else if (late <= 40 * 60000) {
        const btn = document.createElement('button');
        btn.textContent = 'Ir a Comer';
        btn.onclick = () => {
          statusArr[i] = 'done';
          submitMeal(i, 'comido');
          displayMeals();
          window.open('https://glitch.com/edit/#!/temporizador-para-nenes', '_blank');
        };
        block.appendChild(btn);
        status.textContent = '';
        allDone = false;
      } else {
        statusArr[i] = 'missed';
        submitMeal(i, 'perdido');
        status.textContent = '❌';
        status.classList.add('missed');
      }

      block.appendChild(status);
      mealsDiv.appendChild(block);
    });

    if (allDone && meals.length === 4 && meals.every(t => t)) {
      wakeBtn.style.display = 'none';
      mealsDiv.style.display = 'none';
      clearInterval(refreshInterval);
      cerradaVid.style.display = 'block';
      cerradaScreen.style.display = 'flex';
      cerradaVid.play().catch(err => console.warn('Video autoplay blocked:', err));
    } else {
      cerradaVid.style.display = 'none';
      cerradaScreen.style.display = 'none';
      mealsDiv.style.display = 'block';
    }
  }

  async function tryLoadCSV(retries = 5) {
    loaderContainer.style.display = 'flex';
    console.log('Loading CSV... retries left:', retries);
    try {
      const response = await fetch(CSV_URL);
      const csv = await response.text();
      const rows = csv.trim().split('\n').map(r => r.split(','));
      const last = rows[rows.length - 1];
      const today = getTodayStr();
      console.log('CSV last row:', last);

      if (last[1] === today && last[6] && last[7] && last[8] && last[9]) {
        meals = [last[6], last[7], last[8], last[9]];
        statusArr = ['', '', '', ''];
        console.log('Loaded meals:', meals);
        wakeBtn.style.display = 'none';
        wakeBtn.disabled = false;
        displayMeals();
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(displayMeals, 60000);
        loaderContainer.style.display = 'none';
        return true;
      } else {
        if (retries > 0) {
          console.log(`Waiting for sheet update... (${retries} retries left)`);
          setTimeout(() => tryLoadCSV(retries - 1), 2000);
        } else {
          console.warn('No valid meal data found after retries.');
          meals = [];
          statusArr = [];
          wakeBtn.disabled = false;

          if (!hasPressedWakeToday()) {
            wakeBtn.style.display = 'inline-block';
            mealsDiv.innerHTML = '';
          } else {
            mealsDiv.innerHTML = '<p>⚠️ No se encontraron horarios válidos hoy.</p>';
            wakeBtn.style.display = 'none';
          }

          cerradaVid.style.display = 'none';
          cerradaScreen.style.display = 'none';
          loaderContainer.style.display = 'none';
          return false;
        }
      }
    } catch (err) {
      console.error('CSV Fetch Error:', err);
      meals = [];
      statusArr = [];
      wakeBtn.style.display = 'inline-block';
      wakeBtn.disabled = false;
      mealsDiv.innerHTML = '<p>⚠️ Error cargando horarios.</p>';
      cerradaVid.style.display = 'none';
      cerradaScreen.style.display = 'none';
      loaderContainer.style.display = 'none';
      return false;
    }
  }

  wakeBtn.onclick = () => {
    wakeBtn.disabled = true;
    setWakePressedToday();
    console.log('Wake button pressed, sending form...');
    const fd = new URLSearchParams();
    fd.append('entry.1742440048', getTodayStr());
    fd.append('entry.530673272', 'Auto');
    fetch(FORM_URL, { method: 'POST', mode: 'no-cors', body: fd });
    // Wait 15 seconds before fetching sheet data to allow backend to update
    setTimeout(() => tryLoadCSV(5), 15000);
  };

  window.onload = () => {
    if (hasPressedWakeToday()) {
      console.log('Wake button already pressed today, loading CSV...');
      wakeBtn.style.display = 'none';
      tryLoadCSV(5);
    } else {
      console.log('Wake button NOT pressed today, showing button...');
      wakeBtn.style.display = 'inline-block';
      mealsDiv.innerHTML = '';
      cerradaVid.style.display = 'none';
      cerradaScreen.style.display = 'none';
      loaderContainer.style.display = 'none';
    }
  };
</script>

</body>
</html>
