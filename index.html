<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Despertar</title>
<style>
  body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    margin: 0; padding: 2rem;
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    color: #333;
    text-align: center;
    overflow: hidden;
  }
  #cocina-cerrada {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: #111;
    color: #ff4444;
    font-size: clamp(2rem, 10vw, 8rem);
    font-family: 'Courier New', monospace;
    text-transform: uppercase;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    border: 15px dashed #ff4444;
    text-shadow: 0 0 10px #ff4444;
    flex-direction: column;
  }
  #cocina-video {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    z-index: 9998;
    display: none;
  }
  #wake-button {
    font-size: 2rem;
    padding: 1rem 3rem;
    border: none;
    border-radius: 50px;
    background: #ff4b2b;
    color: white;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    margin-bottom: 2rem;
  }
  #meal-times {
    max-width: 400px;
    margin: 0 auto;
    font-size: 1.5rem;
  }
  .meal-block {
    background: #fffcee;
    border-radius: 15px;
    padding: 1rem;
    margin: 1rem 0;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .countdown {
    font-weight: bold;
    color: #444;
    margin-top: 0.5rem;
  }
  .action-btn {
    margin-top: 1rem;
    font-size: 1.2rem;
    padding: 0.6rem 1.2rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background-color: #4caf50;
    color: white;
  }
  .status-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 2rem;
  }
  .status-icon.missed {
    color: red;
  }
  .status-icon.done {
    color: green;
  }
</style>
</head>
<body>

<video id="cocina-video" src="cocina_cerrada.mp4" muted loop></video>

<div id="cocina-cerrada">
  Cocina Cerrada
</div>

<button id="wake-button">¡Despertamos!</button>

<div id="meal-times"></div>

<audio id="alarm-sound" src="cute.mp3" preload="auto"></audio>

<script>
(async function() {
  const wakeBtn = document.getElementById('wake-button');
  const mealTimesDiv = document.getElementById('meal-times');
  const cocinaDiv = document.getElementById('cocina-cerrada');
  const cocinaVideo = document.getElementById('cocina-video');
  const alarmSound = document.getElementById('alarm-sound');

  // Google Form URL for meal logging
  const GOOGLE_FORM_ACTION_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfqhAxYZX-dYDBQySEUtxIpXmzMTRzYw83KFi20qkMC8gF21A/formResponse';

  // Google Form entries (make sure these match your form input names)
  const FORM_ENTRY_DATE = 'entry.1742440048';       // Date (YYYY-MM-DD)
  const FORM_ENTRY_PARTICIPANTS = 'entry.916852138';// Participants (multiple selection)
  const FORM_ENTRY_NAME = 'entry.530673272';        // Your field? (Optional)
  const FORM_ENTRY_STATUS = 'entry.867522782';      // Status (e.g., 'comido' or 'perdido')

  // Constants
  const allowedLateMinutes = 40; // minutes after meal time button disappears and meal marked missed
  const alarmDurationMs = 5 * 60 * 1000; // 5 minutes

  // State
  let meals = [];
  let statusArr = []; // 'pending', 'done', 'missed'
  let countdownIntervals = [];
  let alarmPlayedFor = [];

  // Helpers
  function saveState() {
    localStorage.setItem('lastDate', new Date().toDateString());
    localStorage.setItem('meals', JSON.stringify(meals));
    localStorage.setItem('statusArr', JSON.stringify(statusArr));
  }
  function loadState() {
    const savedMeals = JSON.parse(localStorage.getItem('meals') || '[]');
    const savedStatus = JSON.parse(localStorage.getItem('statusArr') || '[]');
    return { savedMeals, savedStatus };
  }
  function resetAll() {
    meals = [];
    statusArr = [];
    alarmPlayedFor = [];
    clearIntervals();
    mealTimesDiv.innerHTML = '';
    cocinaDiv.style.display = 'none';
    cocinaVideo.style.display = 'none';
    wakeBtn.style.display = 'inline-block';
    localStorage.removeItem('lastDate');
    localStorage.removeItem('meals');
    localStorage.removeItem('statusArr');
  }
  function clearIntervals() {
    countdownIntervals.forEach(clearInterval);
    countdownIntervals = [];
  }

  function formatTime(date) {
    return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: false});
  }

  function parseMealTime(str) {
    const [h, m] = str.split(':').map(Number);
    const d = new Date();
    d.setHours(h, m, 0, 0);
    return d;
  }

  function getTimeDiffString(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }

  // Submit meal status to Google Form
  async function submitMealStatus(mealIndex) {
    const dateStr = new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const participants = ['Dadiva', 'Cypher', 'Harbinjer', 'Evyr']; // Update to your real participants
    const status = statusArr[mealIndex] === 'done' ? 'comido' : 'perdido';

    // Prepare form data - note: this form has multiple entries for participants,
    // so we append multiple entry.916852138 for each participant who ate
    const formData = new URLSearchParams();
    formData.append(FORM_ENTRY_DATE, dateStr);
    formData.append(FORM_ENTRY_NAME, ''); // optional: can be empty or your app user
    formData.append(FORM_ENTRY_STATUS, status);

    // Append all participants — you can adapt to actually submit who ate this meal
    // Here we send all participants, but you might want to send only those who pressed the button
    participants.forEach(p => formData.append(FORM_ENTRY_PARTICIPANTS, p));

    try {
      await fetch(GOOGLE_FORM_ACTION_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData.toString()
      });
      console.log(`Meal ${mealIndex + 1} submitted with status: ${status}`);
    } catch(err) {
      console.error('Error submitting meal:', err);
    }
  }

  // Create meal block element and behavior
  function createMealBlock(index, timeStr) {
    const container = document.createElement('div');
    container.classList.add('meal-block');

    const mealLabel = document.createElement('div');
    mealLabel.textContent = `Comida ${index + 1}: ${timeStr}`;
    container.appendChild(mealLabel);

    const countdown = document.createElement('div');
    countdown.classList.add('countdown');
    container.appendChild(countdown);

    const actionBtn = document.createElement('button');
    actionBtn.classList.add('action-btn');
    actionBtn.textContent = 'Ir a Comer';
    actionBtn.style.display = 'none';
    container.appendChild(actionBtn);

    const statusIcon = document.createElement('div');
    statusIcon.classList.add('status-icon');
    container.appendChild(statusIcon);

    actionBtn.addEventListener('click', () => {
      statusArr[index] = 'done';
      saveState();
      updateMealBlocks();
      window.open('https://glitch.com/edit/#!/temporizador-para-nenes', '_blank');
      submitMealStatus(index); // Submit form on button click
    });

    return { container, countdown, actionBtn, statusIcon };
  }

  // Update the meal blocks UI and logic
  function updateMealBlocks() {
    mealTimesDiv.innerHTML = '';
    const now = new Date();

    let allMealsFinished = true;

    meals.forEach((mealTimeStr, i) => {
      const { container, countdown, actionBtn, statusIcon } = createMealBlock(i, mealTimeStr);
      const mealDate = parseMealTime(mealTimeStr);
      const diffMs = mealDate - now;

      if (!statusArr[i]) statusArr[i] = 'pending';

      if (statusArr[i] === 'done') {
        countdown.textContent = '¡Completado!';
        actionBtn.style.display = 'none';
        statusIcon.textContent = '✅';
        statusIcon.classList.add('done');
        statusIcon.classList.remove('missed');
      } else if (statusArr[i] === 'missed') {
        countdown.textContent = 'Perdido';
        actionBtn.style.display = 'none';
        statusIcon.textContent = '❌';
        statusIcon.classList.add('missed');
        statusIcon.classList.remove('done');
      } else {
        allMealsFinished = false;
        if (diffMs > 0) {
          countdown.textContent = 'Empieza en ' + getTimeDiffString(diffMs);
          actionBtn.style.display = 'none';
          statusIcon.textContent = '';
        } else {
          const lateMs = now - mealDate;
          if (lateMs <= allowedLateMinutes * 60 * 1000) {
            countdown.textContent = '¡Hora de comer!';
            actionBtn.style.display = 'inline-block';
            statusIcon.textContent = '';
          } else {
            statusArr[i] = 'missed';
            saveState();
            countdown.textContent = 'Perdido';
            actionBtn.style.display = 'none';
            statusIcon.textContent = '❌';
            statusIcon.classList.add('missed');
            statusIcon.classList.remove('done');
            submitMealStatus(i); // Submit missed status
          }
        }
      }

      mealTimesDiv.appendChild(container);
    });

    if (allMealsFinished) {
      showCocinaCerrada();
    } else {
      cocinaDiv.style.display = 'none';
      cocinaVideo.style.display = 'none';
      wakeBtn.style.display = 'none';
      mealTimesDiv.style.display = 'block';
    }
  }

  // Play alarm sound for 5 minutes
  function playAlarm() {
    alarmSound.play();
    setTimeout(() => alarmSound.pause(), alarmDurationMs);
  }

  // Check if any alarm should play right now (only once per meal)
  function checkForAlarms() {
    const now = new Date();
    meals.forEach((mealTimeStr, i) => {
      const mealDate = parseMealTime(mealTimeStr);
      if (!alarmPlayedFor[i] && now >= mealDate && now - mealDate < 60000) {
        playAlarm();
        alarmPlayedFor[i] = true;
      }
    });
  }

  // Show Cocina Cerrada screen with background video
  function showCocinaCerrada() {
    mealTimesDiv.style.display = 'none';
    wakeBtn.style.display = 'none';
    cocinaDiv.style.display = 'flex';
    cocinaVideo.style.display = 'block';
    cocinaVideo.play();
  }

  // Start update loop every second
  function startLoop() {
    clearIntervals();
    countdownIntervals.push(setInterval(() => {
      updateMealBlocks();
      checkForAlarms();
    }, 1000));
  }

  // Handle wake button click - fetch meal times from Apps Script Web App
  async function onWakeButtonClick() {
    wakeBtn.disabled = true;
    wakeBtn.textContent = 'Cargando...';

    try {
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/library/d/1pJqV4QRRw7yJseMNTRviNv1C4-M-pSgI9zXjvkTtFdStRhPjTuRRsJYl/12';

      const resp = await fetch(APPS_SCRIPT_URL);
      if (!resp.ok) throw new Error('Error fetching meal times');
      const data = await resp.json();

      if (!data.meals || data.meals.length !== 4) throw new Error('Invalid meals data');

      meals = data.meals;
      statusArr = ['pending', 'pending', 'pending', 'pending'];
      alarmPlayedFor = [false, false, false, false];
      saveState();

      wakeBtn.style.display = 'none';
      updateMealBlocks();
      startLoop();

    } catch (err) {
      alert('Error al obtener horarios: ' + err.message);
      wakeBtn.disabled = false;
      wakeBtn.textContent = '¡Despertamos!';
    }
  }

  // Initialization logic with daily reset at 7AM
  (function initialize() {
    const now = new Date();
    const savedDate = localStorage.getItem('lastDate');
    const { savedMeals, savedStatus } = loadState();

    const isSameDate = savedDate === now.toDateString();
    const allMealsDoneOrMissed = savedStatus.length === 4 && savedStatus.every(s => s === 'done' || s === 'missed');

    if (isSameDate && savedMeals.length === 4) {
      meals = savedMeals;
      statusArr = savedStatus;

      if (allMealsDoneOrMissed) {
        showCocinaCerrada();
      } else {
        wakeBtn.style.display = 'none';
        updateMealBlocks();
        startLoop();
      }
    } else {
      if (now.getHours() >= 7) {
        resetAll();
      } else {
        wakeBtn.style.display = 'none';
        mealTimesDiv.innerHTML = '<p>La cocina estará abierta a las 7 AM.</p>';
      }
    }

    // Auto reset at 7:00 AM daily
    setInterval(() => {
      const current = new Date();
      if (current.getHours() === 7 && current.getMinutes() === 0) {
        resetAll();
      }
    }, 60000);
  })();

  wakeBtn.addEventListener('click', onWakeButtonClick);

})();
</script>

</body>
</html>
