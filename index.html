<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Despertar</title>
<style>
  body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    margin: 0; padding: 2rem;
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    color: #333;
    text-align: center;
    overflow: hidden;
  }
  #cocina-cerrada {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.6);
    color: #ff4444;
    font-size: clamp(2rem, 10vw, 8rem);
    font-family: 'Courier New', monospace;
    text-transform: uppercase;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    border: 15px dashed #ff4444;
    text-shadow: 0 0 10px #ff4444;
    flex-direction: column;
  }
  #cocina-video {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    z-index: 9998;
    display: none;
  }
  #wake-button {
    font-size: 2rem;
    padding: 1rem 3rem;
    border: none;
    border-radius: 50px;
    background: #ff4b2b;
    color: white;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    margin-bottom: 2rem;
  }
  #meal-times {
    max-width: 400px;
    margin: 0 auto;
    font-size: 1.5rem;
  }
  .meal-block {
    background: #fffcee;
    border-radius: 15px;
    padding: 1rem;
    margin: 1rem 0;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .countdown {
    font-weight: bold;
    color: #444;
    margin-top: 0.5rem;
  }
  .action-btn {
    margin-top: 1rem;
    font-size: 1.2rem;
    padding: 0.6rem 1.2rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background-color: #4caf50;
    color: white;
  }
  .status-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 2rem;
  }
  .status-icon.missed {
    color: red;
  }
  .status-icon.done {
    color: green;
  }
</style>
</head>
<body>

<video id="cocina-video" src="cocina_cerrada.mp4" muted loop></video>

<div id="cocina-cerrada">Cocina Cerrada</div>

<button id="wake-button">¡Despertamos!</button>

<div id="meal-times"></div>

<audio id="alarm-sound" src="cute.mp3" preload="auto"></audio>

<script>
(async function() {
  const wakeBtn = document.getElementById('wake-button');
  const mealTimesDiv = document.getElementById('meal-times');
  const cocinaDiv = document.getElementById('cocina-cerrada');
  const cocinaVideo = document.getElementById('cocina-video');
  const alarmSound = document.getElementById('alarm-sound');

  const GOOGLE_FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSfqhAxYZX-dYDBQySEUtxIpXmzMTRzYw83KFi20qkMC8gF21A/formResponse';
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/library/d/1pJqV4QRRw7yJseMNTRviNv1C4-M-pSgI9zXjvkTtFdStRhPjTuRRsJYl/12';

  const allowedLateMinutes = 40;
  const alarmDurationMs = 5 * 60 * 1000;

  let meals = [];
  let statusArr = [];
  let countdowns = [];
  let alarmsPlayed = [];

  function formatTime(date) {
    return date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit', hour12: false});
  }
  function parseTime(str) {
    const [h,m] = str.split(':').map(Number);
    const d = new Date();
    d.setHours(h, m, 0, 0);
    return d;
  }
  function diffString(ms) {
    const min = Math.floor(ms/60000);
    const sec = Math.floor((ms%60000)/1000);
    return `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
  }

  function save() {
    localStorage.setItem('meals', JSON.stringify(meals));
    localStorage.setItem('statusArr', JSON.stringify(statusArr));
    localStorage.setItem('lastDate', new Date().toDateString());
  }
  function load() {
    meals = JSON.parse(localStorage.getItem('meals') || '[]');
    statusArr = JSON.parse(localStorage.getItem('statusArr') || '[]');
  }

  function clearCountdowns() {
    countdowns.forEach(clearInterval);
    countdowns = [];
  }

  function submitWakeForm() {
    const date = new Date().toISOString().split('T')[0];
    const time = new Date().toLocaleTimeString('es-ES', {hour12: false});
    const form = new URLSearchParams();
    form.append('entry.1742440048', date); // Fecha
    form.append('entry.530673272', time); // Hora
    form.append('entry.867522782', 'despertamos');
    return fetch(GOOGLE_FORM_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: form.toString()
    });
  }

  async function onWakeClick() {
    wakeBtn.disabled = true;
    wakeBtn.textContent = 'Cargando...';
    try {
      await submitWakeForm();
      await new Promise(r => setTimeout(r, 2000)); // wait for Apps Script

      const resp = await fetch(APPS_SCRIPT_URL);
      const data = await resp.json();
      if (!data.meals || data.meals.length !== 4) throw new Error('Invalid meals');

      meals = data.meals;
      statusArr = meals.map(() => 'pending');
      alarmsPlayed = meals.map(() => false);
      save();

      wakeBtn.style.display = 'none';
      update();
      startTimers();

    } catch (err) {
      alert('Error al obtener horarios: ' + err.message);
      wakeBtn.disabled = false;
      wakeBtn.textContent = '¡Despertamos!';
    }
  }

  function createMealBlock(i, timeStr) {
    const container = document.createElement('div');
    container.className = 'meal-block';

    const label = document.createElement('div');
    label.textContent = `Comida ${i+1}: ${timeStr}`;
    container.appendChild(label);

    const countdown = document.createElement('div');
    countdown.className = 'countdown';
    container.appendChild(countdown);

    const button = document.createElement('button');
    button.className = 'action-btn';
    button.textContent = 'Ir a Comer';
    button.style.display = 'none';
    container.appendChild(button);

    const icon = document.createElement('div');
    icon.className = 'status-icon';
    container.appendChild(icon);

    button.addEventListener('click', () => {
      statusArr[i] = 'done';
      save();
      update();
      window.open('https://glitch.com/edit/#!/temporizador-para-nenes', '_blank');
    });

    return {container, countdown, button, icon};
  }

  function update() {
    mealTimesDiv.innerHTML = '';
    const now = new Date();
    let allFinished = true;

    meals.forEach((t, i) => {
      const mealTime = parseTime(t);
      const msDiff = mealTime - now;
      const {container, countdown, button, icon} = createMealBlock(i, t);

      if (statusArr[i] === 'done') {
        countdown.textContent = '¡Completado!';
        icon.textContent = '✅';
        icon.classList.add('done');
      } else if (statusArr[i] === 'missed') {
        countdown.textContent = 'Perdido';
        icon.textContent = '❌';
        icon.classList.add('missed');
      } else {
        allFinished = false;
        if (msDiff > 0) {
          countdown.textContent = 'Empieza en ' + diffString(msDiff);
        } else if (-msDiff < allowedLateMinutes * 60000) {
          countdown.textContent = '¡Hora de comer!';
          button.style.display = 'inline-block';
        } else {
          statusArr[i] = 'missed';
          save();
          countdown.textContent = 'Perdido';
          icon.textContent = '❌';
          icon.classList.add('missed');
        }
      }

      mealTimesDiv.appendChild(container);
    });

    if (allFinished) showCocina();
  }

  function startTimers() {
    clearCountdowns();
    countdowns.push(setInterval(() => {
      update();
      checkAlarms();
    }, 1000));
  }

  function checkAlarms() {
    const now = new Date();
    meals.forEach((t, i) => {
      const mt = parseTime(t);
      if (!alarmsPlayed[i] && now >= mt && now - mt < 60000) {
        alarmSound.play();
        alarmsPlayed[i] = true;
      }
    });
  }

  function showCocina() {
    mealTimesDiv.style.display = 'none';
    cocinaDiv.style.display = 'flex';
    cocinaVideo.style.display = 'block';
    cocinaVideo.play();
    wakeBtn.style.display = 'none';
  }

  // Load on page
  const today = new Date().toDateString();
  const storedDate = localStorage.getItem('lastDate');

  if (storedDate === today) {
    load();
    update();
    startTimers();
    wakeBtn.style.display = 'none';
  } else if (new Date().getHours() >= 7) {
    wakeBtn.style.display = 'inline-block';
  } else {
    mealTimesDiv.innerHTML = '<p>La cocina se abre a las 7:00 AM.</p>';
    wakeBtn.style.display = 'none';
  }

  wakeBtn.addEventListener('click', onWakeClick);

})();
</script>
</body>
</html>
