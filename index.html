<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Despertamos</title>
  <style>
    body {
      margin:0;
      padding:2rem;
      font-family: 'Comic Sans MS', cursive;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      text-align:center;
      overflow:hidden;
    }
    #wakeBtn {
      font-size:2rem;
      padding:1rem 3rem;
      background:#ff4b2b;
      color:white;
      border:none;
      border-radius:40px;
      cursor:pointer;
      margin-bottom:2rem;
    }
    .meal {
      background:#fffcee;
      border-radius:15px;
      padding:1rem;
      margin:1rem auto;
      max-width:400px;
      position:relative;
      box-shadow:0 4px 8px rgba(0,0,0,0.1);
    }
    .meal h2 {
      margin:0;
    }
    .meal button {
      margin-top:10px;
      padding:.5rem 1.2rem;
      background:#4caf50;
      color:white;
      border:none;
      border-radius:8px;
      font-size:1.1rem;
      cursor:pointer;
    }
    .status-icon {
      position:absolute;
      top:15px; right:15px;
      font-size:2rem;
    }
    .missed { color:red; }
    .done { color:green; }
    #cocinaCerrada {
      display:none;
      position:fixed;
      top:0; left:0; width:100vw; height:100vh;
      justify-content:center;
      align-items:center;
      color:#ff4444;
      font-size:4rem;
      z-index:2;
      border:15px dashed #ff4444;
      text-shadow:0 0 10px #ff4444;
      background:rgba(0,0,0,0.5);
    }
    video#closedVideo {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100vw; height:100vh;
      object-fit:cover;
      z-index:1;
    }
    audio#alarm { display:none; }
  </style>
</head>
<body>

  <button id="wakeBtn">¡Despertamos!</button>
  <div id="mealContainer"></div>
  <div id="cocinaCerrada">Cocina Cerrada</div>
  <video id="closedVideo" loop muted>
    <source src="cocina_cerrada.mp4" type="video/mp4" />
  </video>
  <audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

  <script>
    const formUrl = "https://docs.google.com/forms/d/e/1FAIpQLSfqhAxYZX-dYDBQySEUtxIpXmzMTRzYw83KFi20qkMC8gF21A/formResponse";
    const ENTRY_DATE = "entry.1742440048";
    const ENTRY_MEAL = "entry.530673272";
    const ENTRY_PARTICIPANTS = "entry.916852138";
    const ENTRY_STATUS = "entry.867522782";
    const participants = ["Dadiva", "Cypher", "Harbinjer", "Evyr"];

    const LS_MEALS = "despertamos_meals";
    const LS_STATUS = "despertamos_status";
    const LS_DATE = "despertamos_date";

    let meals=[], mealStatus=[];

    function addHours(d,h){ let dt=new Date(d); dt.setHours(dt.getHours()+h); return dt; }
    function formatTime(d){ return d.toTimeString().slice(0,5); }
    function todayStr(){ return new Date().toISOString().split("T")[0]; }

    function sendForm(mealIndex, status){
      const data = new URLSearchParams();
      data.append(ENTRY_DATE, todayStr());
      data.append(ENTRY_MEAL, `Comida ${mealIndex+1}`);
      data.append(ENTRY_PARTICIPANTS, participants.join(", "));
      data.append(ENTRY_STATUS, status);
      fetch(formUrl, {
        method:"POST", mode:"no-cors",
        body: data.toString(),
        headers: {"Content-Type":"application/x-www-form-urlencoded"}
      })
      .then(() => console.log("✅ Sent", mealIndex+1, status))
      .catch(e => console.error("❌ Form send err", e));
    }

    const wakeBtn = document.getElementById("wakeBtn");
    const mc = document.getElementById("mealContainer");
    const cocina = document.getElementById("cocinaCerrada");
    const vid = document.getElementById("closedVideo");
    const alarm = document.getElementById("alarm");

    function saveState(){
      localStorage.setItem(LS_MEALS, JSON.stringify(meals));
      localStorage.setItem(LS_STATUS, JSON.stringify(mealStatus));
      localStorage.setItem(LS_DATE, new Date().toDateString());
    }

    function loadState(){
      if(localStorage.getItem(LS_DATE)===new Date().toDateString()){
        const m=localStorage.getItem(LS_MEALS), s=localStorage.getItem(LS_STATUS);
        if(m && s){ meals=JSON.parse(m); mealStatus=JSON.parse(s); return true; }
      }
      return false;
    }

    function render(){
      mc.innerHTML="";
      const now=new Date(), autoMarkAfter=40*60*1000;
      let allDone=true;

      meals.forEach((mt,i)=>{
        const dmt=new Date(mt), diff=now-dmt;
        const box = document.createElement("div");
        box.className="meal";
        box.innerHTML = `<h2>Comida ${i+1} – ${formatTime(dmt)}</h2>`;
        const btn = document.createElement("button");
        btn.textContent="Ir a Comer";
        const statusIcon = document.createElement("div");
        statusIcon.className="status-icon";

        if(mealStatus[i]==="done"){
          statusIcon.textContent="✅"; statusIcon.classList.add("done");
          btn.style.display="none";
        } else if(mealStatus[i]==="missed"){
          statusIcon.textContent="❌"; statusIcon.classList.add("missed");
          btn.style.display="none";
        } else if(diff>=0 && diff<=autoMarkAfter){
          btn.style.display="inline-block";
          btn.onclick = ()=>{
            mealStatus[i]="done"; saveState();
            sendForm(i,"comido"); render(); alarm.play();
            window.open("https://temporizador-para-nenes.glitch.me","_blank");
          };
          allDone=false;
        } else if(diff>autoMarkAfter){
          mealStatus[i]="missed"; saveState();
          sendForm(i,"perdido");
          statusIcon.textContent="❌"; statusIcon.classList.add("missed");
        } else {
          btn.style.display="none";
          allDone=false;
        }

        box.appendChild(btn);
        box.appendChild(statusIcon);
        mc.appendChild(box);
      });

      if(allDone && meals.length>0){
        cocina.style.display="flex"; vid.style.display="block"; vid.play();
      } else {
        cocina.style.display="none"; vid.style.display="none"; vid.pause();
      }
    }

    wakeBtn.onclick = ()=>{
      const now=new Date();
      meals=[addHours(now,1),addHours(now,5),addHours(now,9),addHours(now,13)];
      mealStatus=[null,null,null,null];
      saveState(); render();
      setInterval(render,60000);
      wakeBtn.style.display="none";
    };

    window.addEventListener("DOMContentLoaded",()=>{
      const loaded=loadState(), now=new Date();
      if(loaded){
        render();
        setInterval(render,60000);
        wakeBtn.style.display="none";
      } else {
        wakeBtn.style.display = now.getHours()>=7 ? "inline-block" : "none";
      }
    });
  </script>
</body>
</html>
