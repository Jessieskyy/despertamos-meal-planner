<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Meal Planner</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Fredoka One', cursive;
      text-align: center;
      color: white;
      overflow: hidden;
    }
    #bgVideo {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: cover;
      z-index: -2;
      display: none;
    }
    #overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: -1;
    }
    h1 {
      margin-top: 1em;
      background: rgba(0,0,0,0.5);
      padding: 0.5em 1em;
      border-radius: 10px;
    }
    button {
      font-size: 1.5em;
      padding: 1em 2em;
      margin: 0.5em;
      border: none;
      border-radius: 20px;
      background: #ff6f91;
      color: white;
      cursor: pointer;
      transition: transform 0.2s;
    }
    button:hover:not(:disabled) {
      transform: scale(1.1);
    }
    .meal {
      background: rgba(255, 255, 255, 0.8);
      color: #333;
      margin: 1em auto;
      padding: 1em;
      border-radius: 15px;
      width: 300px;
      font-size: 1.2em;
      position: relative;
    }
    .missed { color: red; }
  </style>
</head>
<body>

<video id="bgVideo" autoplay muted loop>
  <source src="cocina_cerrada.mp4" type="video/mp4" />
  Tu navegador no soporta videos.
</video>
<div id="overlay"></div>

<h1 id="title">¡Despertamos!</h1>
<button id="wake-btn" style="display:none;">Registrar Hora Actual</button>

<div id="meals"></div>

<audio id="alarmSound" src="cute.mp3" preload="auto"></audio>

<script>
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfqhAxYZX-dYDBQySEUtxIpXmzMTRzYw83KFi20qkMC8gF21A/formResponse";
const SHEET_ID = "1XEeQL89J-Hd1AiGTOwBbkXYgOInf_m9Z1tPvTI-S3d4";
const SHEET_NAME = "MealData";
const ENTRY_DATE = "entry.1742440048";
const ENTRY_TIME = "entry.530673272";
const ENTRY_STATUS = "entry.867522782";
const ENTRY_PARTICIPANTS = "entry.916852138";
const GRACE = 40;
const TIMER_APP = "https://glitch.com/edit/#!/temporizador-para-nenes";
const PARTICIPANTS = ["Dadiva","Cypher","Harbinjer"];
let meals = [];

function pad(n){return n.toString().padStart(2,'0');}
function nowHHMM(){ const d = new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}`;}
function diffMinutes(t){
  let [h,m] = t.split(':').map(Number);
  const d = new Date(); const mtime = new Date(); mtime.setHours(h,m,0,0);
  return Math.floor((d - mtime)/60000);
}
function canWake() { return new Date().getHours() >= 7; }

async function sendWake() {
  document.getElementById('wake-btn').innerText = "Enviando...";
  const d = new URLSearchParams();
  d.append(ENTRY_DATE, new Date().toISOString().split('T')[0]);
  d.append(ENTRY_TIME, nowHHMM());
  await fetch(FORM_URL,{method:'POST',mode:'no-cors',body:d});
  setTimeout(loadMeals, 3000);
}

async function submitMissed(t) {
  const d = new URLSearchParams();
  d.append(ENTRY_DATE, new Date().toISOString().split('T')[0]);
  d.append(ENTRY_TIME, t);
  d.append(ENTRY_STATUS, "perdido");
  PARTICIPANTS.forEach(p => d.append(ENTRY_PARTICIPANTS, p));
  await fetch(FORM_URL,{method:'POST',mode:'no-cors',body:d});
}

function createMealBlock(label, t) {
  const div = document.createElement('div');
  div.className = 'meal';
  const diff = diffMinutes(t);
  if (diff >= 0 && diff <= GRACE) {
    div.innerHTML = `<strong>${label}: ${t}</strong><br/>
      <button onclick="window.open('${TIMER_APP}','_blank')">✅ Ir a Comer</button>`;
  } else if (diff > GRACE) {
    div.classList.add('missed');
    div.innerHTML = `<strong>${label}: ${t}</strong><br/>❌ Perdido`;
    submitMissed(t);
  } else {
    div.innerHTML = `<strong>${label}: ${t}</strong><br/>Comienza en ${-diff} min`;
  }
  return div;
}

async function loadMeals() {
  let out = document.getElementById('meals');
  try {
    const q = encodeURIComponent("SELECT * ORDER BY A DESC LIMIT 1");
    const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_NAME}&tq=${q}`);
    const txt = await res.text();
    const j = JSON.parse(txt.substr(47).slice(0,-2));
    const c = j.table.rows[0].c;
    meals = [c[2]?.v, c[3]?.v, c[4]?.v, c[5]?.v];
    out.innerHTML = "<h2>Horarios de Comida:</h2>";
    meals.forEach((t,i) => out.appendChild(createMealBlock(`Comida ${i+1}`,t)));
  } catch(e) {
    out.innerHTML = "<p>Error cargando horarios</p>";
    console.error(e);
  }
}

window.onload = () => {
  const btn = document.getElementById('wake-btn');
  const ttl = document.getElementById('title');
  if (canWake()) {
    btn.style.display = "block";
    btn.onclick = sendWake;
  } else {
    ttl.innerText = "Abre a las 7 AM";
  }

  loadMeals();
  setInterval(loadMeals, 60000);

  // Show background video after meals end (optional)
  setTimeout(() => {
    if (document.querySelectorAll('.meal.missed, .meal button:empty').length === meals.length)
      document.getElementById('bgVideo').style.display = 'block';
  }, (GRACE+1)*60*60*1000);
};
</script>

</body>
</html>
