<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>¬°Despertamos!</title>
  <style>
    body {
      font-family: 'Comic Sans MS', cursive;
      margin: 0;
      padding: 2rem;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      text-align: center;
    }
    button {
      font-size: 2rem;
      padding: 1rem 2rem;
      background-color: #ff4b2b;
      color: white;
      border: none;
      border-radius: 40px;
      cursor: pointer;
    }
    .meal {
      margin: 1.5rem auto;
      padding: 1rem;
      max-width: 400px;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .meal h3 {
      margin: 0.5rem 0;
    }
    .action-btn {
      margin-top: 0.5rem;
      background: #4CAF50;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
    }
    .status {
      font-size: 2rem;
    }
    .missed {
      color: red;
    }
    .done {
      color: green;
    }
    #cocina-cerrada {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: black;
      color: red;
      font-size: 4rem;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      z-index: 10;
    }
  </style>
</head>
<body>

<h1>¬°Despertamos!</h1>
<button id="wakeBtn">¬°Empezar el d√≠a!</button>
<div id="mealsContainer"></div>
<div id="cocina-cerrada">üçΩ Cocina Cerrada üçΩ</div>
<audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
const GOOGLE_FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfqhAxYZX-dYDBQySEUtxIpXmzMTRzYw83KFi20qkMC8gF21A/formResponse";
const ENTRY_DATE = "entry.1742440048";
const ENTRY_MEAL = "entry.530673272";
const ENTRY_PARTICIPANTS = "entry.916852138";
const ENTRY_STATUS = "entry.867522782";

const participants = ["Dadiva", "Cypher", "Harbinjer", "Evyr"];
let meals = [];
let mealStatus = [];

function formatTime(date) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function addHours(date, h) {
  let d = new Date(date);
  d.setHours(d.getHours() + h);
  return d;
}

function playAlarm() {
  const alarm = document.getElementById("alarm");
  alarm.play();
  setTimeout(() => alarm.pause(), 5 * 60 * 1000);
}

function submitMealData(index, status) {
  const mealTime = meals[index];
  const dateStr = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

  const formData = new URLSearchParams();
  formData.append(ENTRY_DATE, dateStr);
  formData.append(ENTRY_MEAL, `Comida ${index + 1}`);
  participants.forEach(p => formData.append(ENTRY_PARTICIPANTS, p));
  formData.append(ENTRY_STATUS, status);

  fetch(GOOGLE_FORM_URL, {
    method: "POST",
    mode: "no-cors",
    body: formData
  }).then(() => {
    console.log(`üì¨ Sent ${status} for Meal ${index + 1}`);
  });
}

function renderMeals() {
  const container = document.getElementById("mealsContainer");
  container.innerHTML = "";

  const now = new Date();

  let allDone = true;

  meals.forEach((time, index) => {
    const div = document.createElement("div");
    div.className = "meal";
    const timeDiff = new Date(time) - now;
    const minsLate = (now - new Date(time)) / (1000 * 60);

    div.innerHTML = `
      <h3>Comida ${index + 1}: ${formatTime(new Date(time))}</h3>
      <div id="status${index}" class="status">‚è≥</div>
    `;

    if (mealStatus[index] === "done") {
      div.querySelector(".status").textContent = "‚úÖ";
      div.querySelector(".status").classList.add("done");
    } else if (mealStatus[index] === "missed") {
      div.querySelector(".status").textContent = "‚ùå";
      div.querySelector(".status").classList.add("missed");
    } else if (timeDiff <= 0 && minsLate <= 40) {
      const btn = document.createElement("button");
      btn.className = "action-btn";
      btn.textContent = "Ir a Comer";
      btn.onclick = () => {
        mealStatus[index] = "done";
        submitMealData(index, "comido");
        renderMeals();
        window.open("https://temporizador-para-nenes.glitch.me", "_blank");
      };
      div.appendChild(btn);
      playAlarm();
      allDone = false;
    } else if (minsLate > 40 && mealStatus[index] !== "done") {
      mealStatus[index] = "missed";
      submitMealData(index, "perdido");
      renderMeals();
    } else {
      allDone = false;
    }

    container.appendChild(div);
  });

  if (allDone) {
    document.getElementById("cocina-cerrada").style.display = "flex";
  }
}

document.getElementById("wakeBtn").addEventListener("click", () => {
  const now = new Date();
  meals = [
    addHours(now, 1),
    addHours(now, 5),
    addHours(now, 9),
    addHours(now, 13)
  ];
  mealStatus = [null, null, null, null];
  renderMeals();
  setInterval(renderMeals, 60 * 1000);
});
</script>
</body>
</html>
