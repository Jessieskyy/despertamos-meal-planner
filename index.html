<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Despertar</title>
<style>
  body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    margin: 0; padding: 2rem;
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    color: #333;
    text-align: center;
  }
  #cocina-cerrada {
    display: none;
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    background: #111;
    color: #ff4444;
    font-size: clamp(2rem, 10vw, 8rem);
    font-family: 'Courier New', monospace;
    text-transform: uppercase;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    border: 15px dashed #ff4444;
    text-shadow: 0 0 10px #ff4444;
    flex-direction: column;
  }
  #cocina-video {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    object-fit: cover;
    z-index: 9998;
    display: none;
  }
  #wake-button {
    font-size: 2rem;
    padding: 1rem 3rem;
    border: none;
    border-radius: 50px;
    background: #ff4b2b;
    color: white;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    margin-bottom: 2rem;
  }
  #meal-times {
    max-width: 400px;
    margin: 0 auto;
    font-size: 1.5rem;
  }
  .meal-block {
    background: #fffcee;
    border-radius: 15px;
    padding: 1rem;
    margin: 1rem 0;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    position: relative;
  }
  .countdown {
    font-weight: bold;
    color: #444;
    margin-top: 0.5rem;
  }
  .action-btn {
    margin-top: 1rem;
    font-size: 1.2rem;
    padding: 0.6rem 1.2rem;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    background-color: #4caf50;
    color: white;
  }
  .status-icon {
    position: absolute;
    top: 15px;
    right: 15px;
    font-size: 2rem;
  }
  .status-icon.missed {
    color: red;
  }
  .status-icon.done {
    color: green;
  }
</style>
</head>
<body>

<video id="cocina-video" autoplay muted loop>
  <source src="your_cocina_cerrada_video.mp4" type="video/mp4" />
  Tu navegador no soporta video.
</video>

<div id="cocina-cerrada">Cocina Cerrada</div>

<button id="wake-button">¡Despertamos!</button>

<div id="meal-times"></div>

<audio id="alarm-sound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
(async function() {
  const wakeBtn = document.getElementById('wake-button');
  const mealTimesDiv = document.getElementById('meal-times');
  const cocinaCerrada = document.getElementById('cocina-cerrada');
  const cocinaVideo = document.getElementById('cocina-video');
  const alarmSound = document.getElementById('alarm-sound');

  // Google Form POST URL and entries — Replace if your form changes!
  const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfqhAxYZX-dYDBQySEUtxIpXmzMTRzYw83KFi20qkMC8gF21A/formResponse";
  const ENTRY_DATE = "entry.1742440048";
  const ENTRY_MEAL = "entry.530673272";
  const ENTRY_PARTICIPANTS = "entry.916852138"; // multiple participants supported by repeating
  const ENTRY_STATUS = "entry.867522782";

  const allowedLateMinutes = 40; // Minutes after meal time button disappears (missed)
  const alarmDurationMs = 5 * 60 * 1000; // 5 minutes alarm sound

  // Participants list (choose who can eat)
  const participants = ["Dadiva", "Cypher", "Harbinjer", "Evyr"];

  let meals = [];
  let mealStatus = []; // 'pending', 'done', 'missed'
  let countdownIntervals = [];
  let alarmPlayedFor = [];

  // Save/load meal status & schedule, plus last reset date in localStorage
  function saveState() {
    localStorage.setItem('mealStatus', JSON.stringify(mealStatus));
    localStorage.setItem('meals', JSON.stringify(meals));
    localStorage.setItem('lastResetDate', new Date().toDateString());
  }
  function loadState() {
    const savedStatus = localStorage.getItem('mealStatus');
    const savedMeals = localStorage.getItem('meals');
    if (savedStatus) mealStatus = JSON.parse(savedStatus);
    if (savedMeals) meals = JSON.parse(savedMeals);
  }

  // Reset everything
  function resetState() {
    meals = [];
    mealStatus = [];
    alarmPlayedFor = [];
    countdownIntervals.forEach(clearInterval);
    countdownIntervals = [];
    mealTimesDiv.innerHTML = '';
    cocinaCerrada.style.display = 'none';
    cocinaVideo.style.display = 'none';
    wakeBtn.style.display = 'inline-block';
    localStorage.removeItem('mealStatus');
    localStorage.removeItem('meals');
    localStorage.removeItem('lastResetDate');
  }

  // Format time as 12-hour string with AM/PM
  function formatTime(d) {
    let h = d.getHours(), m = d.getMinutes();
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12; if (h === 0) h = 12;
    return `${h}:${m.toString().padStart(2,'0')} ${ampm}`;
  }

  // Parse HH:mm string to today Date
  function parseMealTime(str) {
    const [h,m] = str.split(':').map(Number);
    const d = new Date();
    d.setHours(h, m, 0, 0);
    return d;
  }

  // Time difference string mm:ss
  function getTimeDiffString(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
  }

  // Show Cocina Cerrada screen + video
  function showCocinaCerrada() {
    cocinaCerrada.style.display = 'flex';
    cocinaVideo.style.display = 'block';
    mealTimesDiv.style.display = 'none';
    wakeBtn.style.display = 'none';
  }

  // Create meal block HTML with participant checkboxes
  function createMealBlock(index, timeStr) {
    const container = document.createElement('div');
    container.classList.add('meal-block');

    const mealLabel = document.createElement('div');
    mealLabel.textContent = `Comida ${index + 1}: ${timeStr}`;
    container.appendChild(mealLabel);

    const countdown = document.createElement('div');
    countdown.classList.add('countdown');
    container.appendChild(countdown);

    const participantContainer = document.createElement('div');
    participantContainer.style.marginTop = '10px';

    participants.forEach(name => {
      const label = document.createElement('label');
      label.style.marginRight = '10px';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.participant = name;
      // disable checkboxes if meal done or missed
      cb.disabled = mealStatus[index] === 'done' || mealStatus[index] === 'missed';
      label.appendChild(cb);
      label.appendChild(document.createTextNode(name));
      participantContainer.appendChild(label);
    });
    container.appendChild(participantContainer);

    const actionBtn = document.createElement('button');
    actionBtn.classList.add('action-btn');
    actionBtn.textContent = 'Ir a Comer';
    actionBtn.style.display = 'none';
    container.appendChild(actionBtn);

    const statusIcon = document.createElement('div');
    statusIcon.classList.add('status-icon');
    container.appendChild(statusIcon);

    // When pressed, send selected participants and mark done
    actionBtn.addEventListener('click', async () => {
      const selectedParticipants = Array.from(participantContainer.querySelectorAll('input[type=checkbox]:checked')).map(cb => cb.dataset.participant);

      if (selectedParticipants.length === 0) {
        alert('Selecciona al menos un participante para esta comida.');
        return;
      }

      // Send data to Google Form
      try {
        await submitMealToForm(meals[index], index + 1, selectedParticipants, 'comido');
        mealStatus[index] = 'done';
        saveState();
        updateMealBlocks();
        window.open('https://glitch.com/edit/#!/temporizador-para-nenes', '_blank');
      } catch (e) {
        alert('Error enviando datos: ' + e.message);
      }
    });

    return { container, countdown, participantContainer, actionBtn, statusIcon };
  }

  // Submit to Google Form via POST (multiple participants)
  async function submitMealToForm(dateStr, mealNum, participants, status) {
    // Google Form expects repeated params for multiple selections
    // Build form data
    const data = new URLSearchParams();
    data.append(ENTRY_DATE, dateStr);
    data.append(ENTRY_MEAL, `Comida ${mealNum}`);
    participants.forEach(p => data.append(ENTRY_PARTICIPANTS, p));
    data.append(ENTRY_STATUS, status);

    const resp = await fetch(FORM_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: data.toString()
    });

    // no-cors, no response available — assume success
  }

  // Update meal blocks UI every second
  function updateMealBlocks() {
    mealTimesDiv.innerHTML = '';
    const now = new Date();

    let allDone = true;

    meals.forEach((mealTimeStr, i) => {
      const { container, countdown, participantContainer, actionBtn, statusIcon } = createMealBlock(i, mealTimeStr);
      const mealDate = parseMealTime(mealTimeStr);
      const diffMs = mealDate - now;

      if (!mealStatus[i]) mealStatus[i] = 'pending';

      if (mealStatus[i] === 'done') {
        countdown.textContent = '¡Completado!';
        actionBtn.style.display = 'none';
        participantContainer.querySelectorAll('input').forEach(cb => cb.disabled = true);
        statusIcon.textContent = '✅';
        statusIcon.classList.add('done');
        statusIcon.classList.remove('missed');
      } else if (mealStatus[i] === 'missed') {
        countdown.textContent = 'Perdido';
        actionBtn.style.display = 'none';
        participantContainer.querySelectorAll('input').forEach(cb => cb.disabled = true);
        statusIcon.textContent = '❌';
        statusIcon.classList.add('missed');
        statusIcon.classList.remove('done');
      } else {
        allDone = false;

        if (diffMs > 0) {
          countdown.textContent = 'Empieza en ' + getTimeDiffString(diffMs);
          actionBtn.style.display = 'none';
          statusIcon.textContent = '';
        } else {
          const lateMs = now - mealDate;
          if (lateMs <= allowedLateMinutes * 60 * 1000) {
            countdown.textContent = '¡Hora de comer!';
            actionBtn.style.display = 'inline-block';
            statusIcon.textContent = '';
          } else {
            mealStatus[i] = 'missed';
            saveState();
            countdown.textContent = 'Perdido';
            actionBtn.style.display = 'none';
            statusIcon.textContent = '❌';
            statusIcon.classList.add('missed');
            statusIcon.classList.remove('done');
            participantContainer.querySelectorAll('input').forEach(cb => cb.disabled = true);
          }
        }
      }

      mealTimesDiv.appendChild(container);
    });

    if (allDone) {
      showCocinaCerrada();
    } else {
      cocinaCerrada.style.display = 'none';
      cocinaVideo.style.display = 'none';
      mealTimesDiv.style.display = 'block';
      wakeBtn.style.display = 'none';
    }
  }

  // Play alarm sound at meal time start (only once per meal)
  function playAlarm() {
    alarmSound.play();
    setTimeout(() => alarmSound.pause(), alarmDurationMs);
  }

  function startCountdownTimers() {
    countdownIntervals.forEach(clearInterval);
    countdownIntervals = [];

    countdownIntervals.push(setInterval(() => {
      updateMealBlocks();
      checkForAlarms();
      checkResetAt7AM();
    }, 1000));
  }

  // Track alarms played per meal index
  alarmPlayedFor = [];

  function checkForAlarms() {
    const now = new Date();

    meals.forEach((mealTimeStr, i) => {
      const mealDate = parseMealTime(mealTimeStr);

      if (!alarmPlayedFor[i] && now >= mealDate && now - mealDate < 60 * 1000) {
        playAlarm();
        alarmPlayedFor[i] = true;
      }
    });
  }

  // Check daily reset at 7:00 AM
  function checkResetAt7AM() {
    const now = new Date();
    if (now.getHours() === 7 && now.getMinutes() === 0 && now.getSeconds() === 0) {
      resetState();
    }
  }

  // Called when wake button pressed - fetch meals from Apps Script Web App
  async function onWakeButtonClick() {
    wakeBtn.disabled = true;
    wakeBtn.textContent = 'Cargando...';

    try {
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwKRSkIg4OPhoW7pt607Ds6Oe4N3h4u54CRBYaGHqA0t73t9PX5bcG0x43Vuwmrp1P8UA/exec';

      const resp = await fetch(APPS_SCRIPT_URL);
      if (!resp.ok) throw new Error('Error fetching meal times');
      const data = await resp.json();

      if (!data.meals || data.meals.length !== 4) throw new Error('Invalid meals data');

      meals = data.meals;
      mealStatus = Array(meals.length).fill('pending');
      alarmPlayedFor = [];
      saveState();

      wakeBtn.style.display = 'none';
      updateMealBlocks();
      startCountdownTimers();

    } catch (err) {
      alert('Error al obtener horarios: ' + err.message);
      wakeBtn.disabled = false;
      wakeBtn.textContent = '¡Despertamos!';
    }
  }

  // Load saved state & init or show button to start
  function init() {
    loadState();

    // If saved meals for today exist, show them, else show button
    const lastResetDate = localStorage.getItem('lastResetDate');
    const today = new Date().toDateString();
    if (lastResetDate === today && meals.length === 4) {
      updateMealBlocks();
      startCountdownTimers();
      wakeBtn.style.display = 'none';
    } else {
      resetState();
    }
  }

  // On page load:
  init();

  // Button handler
  wakeBtn.addEventListener('click', onWakeButtonClick);

})();
</script>

</body>
</html>
